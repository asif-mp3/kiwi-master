# Voice-Enabled Google Sheets Analytics Platform

An AI-powered conversational analytics system that transforms Google Sheets into a queryable database through natural language (voice or text). Built with a sophisticated RAG (Retrieval-Augmented Generation) architecture supporting **10 query types**, multi-language support (English/Tamil), and real-time voice interaction.

---

## Table of Contents

1. [Overview](#overview)
2. [System Architecture](#system-architecture)
3. [Project Structure](#project-structure)
4. [Backend Architecture](#backend-architecture)
5. [Frontend Architecture](#frontend-architecture)
6. [Query Types](#query-types)
7. [Data Flow](#data-flow)
8. [Setup & Installation](#setup--installation)
9. [Configuration](#configuration)
10. [API Reference](#api-reference)
11. [Troubleshooting](#troubleshooting)

---

## Overview

### What Kiwi Does

Kiwi enables users to ask questions about Google Sheets data using natural language - either by typing or speaking. The system:

- **Auto-detects tables** within Google Sheets (handles multiple tables per sheet)
- **Builds semantic indexes** for intelligent query routing
- **Generates SQL queries** from natural language using LLM
- **Executes queries** via in-memory DuckDB analytics engine
- **Explains results** in plain language (English or Tamil)
- **Supports voice interaction** via ElevenLabs STT/TTS

### Key Features

| Feature | Description |
|---------|-------------|
| **10 Query Types** | metric, lookup, filter, extrema_lookup, rank, list, aggregation_on_subset, comparison, percentage, trend |
| **Multi-Language** | English and Tamil with automatic detection |
| **Voice Interface** | Real-time STT (Scribe v2) and TTS (Multilingual v2) |
| **Smart Table Detection** | Auto-detects multiple tables in single sheets |
| **Change Detection** | SHA-256 hash-based incremental updates |
| **Conversation Memory** | Persistent user preferences and context |
| **Self-Healing Queries** | Auto-corrects failed queries with fuzzy matching |

---

## System Architecture

### Complete User Flow Diagram

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                           ğŸ¯ USER INTERACTION                                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                           â•‘
â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â•‘
â•‘    â”‚   ğŸ¤ Voice   â”‚         â”‚  âŒ¨ï¸  Text    â”‚         â”‚  ğŸ“Š Google Sheet    â”‚                               â•‘
â•‘    â”‚   Input     â”‚         â”‚   Input     â”‚         â”‚     URL Input       â”‚                               â•‘
â•‘    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â•‘
â•‘           â”‚                       â”‚                           â”‚                                          â•‘
â•‘           â–¼                       â–¼                           â–¼                                          â•‘
â•‘    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                       â•‘
â•‘    â•‘                         FRONTEND (Next.js 15 + React)                        â•‘                       â•‘
â•‘    â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘                       â•‘
â•‘    â•‘  â”‚                        ChatScreen.tsx (Main UI)                        â”‚ â•‘                       â•‘
â•‘    â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â•‘                       â•‘
â•‘    â•‘  â”‚  â”‚ VoiceRecorder â”‚  â”‚  ChatInput     â”‚  â”‚  DatasetConnection      â”‚   â”‚ â•‘                       â•‘
â•‘    â•‘  â”‚  â”‚ (ElevenLabs   â”‚  â”‚  (Text entry)  â”‚  â”‚  (Sheet URL + Sync)     â”‚   â”‚ â•‘                       â•‘
â•‘    â•‘  â”‚  â”‚  Scribe STT)  â”‚  â”‚                â”‚  â”‚                         â”‚   â”‚ â•‘                       â•‘
â•‘    â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â•‘                       â•‘
â•‘    â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘                       â•‘
â•‘    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                       â•‘
â•‘                  â”‚                  â”‚                         â”‚                                          â•‘
â•‘                  â”‚    HTTP POST     â”‚        HTTP POST        â”‚                                          â•‘
â•‘                  â”‚  /api/transcribe â”‚        /api/query       â”‚  /api/load-dataset                      â•‘
â•‘                  â–¼                  â–¼                         â–¼                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                           â•‘
â•‘    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â•‘
â•‘    â•‘                              BACKEND API (FastAPI - Port 8000)                                     â•‘ â•‘
â•‘    â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â•‘
â•‘    â•‘  â”‚                              api/main.py (Entry Point)                                       â”‚  â•‘ â•‘
â•‘    â•‘  â”‚                                       â”‚                                                      â”‚  â•‘ â•‘
â•‘    â•‘  â”‚                                       â–¼                                                      â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚                       api/services.py (Main Orchestrator)                              â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚                                                                                        â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚                        process_query() Function                                  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚                                                                                  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚  1. Language Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â”‚                                                                         â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â–¼                                                                         â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚  2. Greeting/Memory Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â”‚ greeting_detector.py â”€â”€â–º Handle greetings                           â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â”‚ memory_detector.py â”€â”€â”€â”€â–º Store "Call me X" preferences              â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â–¼                                                                      â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚  3. Translation (if Tamil) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â”‚ translation.py â”€â”€â”€â”€â”€â”€â”€â”€â–º Gemini 1.5 Flash                       â”‚   â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â–¼                                                                  â”‚   â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚  4. Schema Retrieval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â”‚                                                              â”‚   â”‚   â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â”‚     â–¼                                                              â”‚   â”‚   â”‚  â”‚  â”‚ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â•‘ â•‘
â•‘    â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â•‘ â•‘
â•‘    â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â•‘
â•‘    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â•‘
â•‘                                                                                                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                     ğŸ“¦ PROCESSING LAYERS (5 Stages)                                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                                                                                                      â”‚ â•‘
â•‘  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚ â•‘
â•‘  â”‚    â”ƒ  STAGE 1: SCHEMA INTELLIGENCE                                        ğŸ“š schema_intelligence/ â”ƒ   â”‚ â•‘
â•‘  â”‚    â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   User Query â”€â”€â”€â”€â”€â–º chromadb_client.py â”€â”€â”€â”€â”€â–º Semantic Search (top_k=50)                     â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                    â”‚                         â”‚                                       â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                    â–¼                         â–¼                                       â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â”‚   ChromaDB       â”‚      â”‚  hybrid_retriever  â”‚                          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â”‚  Vector Store    â”‚â—„â”€â”€â”€â”€â–ºâ”‚  (Semantic+Keyword)â”‚                          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â”‚  (Embeddings)    â”‚      â”‚                    â”‚                          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                    â”‚                                                                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                    â–¼                                                                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â”‚ schema_extractor â”‚ â”€â”€â–º Extract column names, types, sample values       â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                    â”‚                                                                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â–¼                    â–¼                                                                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   Schema Context String (table names, columns, types, sample values)                         â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”‚ â•‘
â•‘  â”‚                                           â”‚                                                         â”‚ â•‘
â•‘  â”‚                                           â–¼                                                         â”‚ â•‘
â•‘  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚ â•‘
â•‘  â”‚    â”ƒ  STAGE 2: PLANNING LAYER                                                ğŸ“‹ planning_layer/ â”ƒ   â”‚ â•‘
â•‘  â”‚    â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   Query + Schema â”€â”€â”€â”€â–º planner_client.py â”€â”€â”€â”€â–º Gemini 2.0 Flash â”€â”€â”€â”€â–º JSON Query Plan       â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚                     â”‚                      â”‚                      â”‚                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚                     â–¼                      â–¼                      â–¼                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚            â”‚ planner_prompt â”‚     â”‚ table_router   â”‚     â”‚ entity_extractorâ”‚        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚            â”‚ (10 query type â”‚     â”‚ (Smart table   â”‚     â”‚ (Extract names, â”‚        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚            â”‚  examples)     â”‚     â”‚  selection)    â”‚     â”‚  dates, values) â”‚        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â”‚                                                                                     â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ         â–¼                                                                                     â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   JSON Query Plan:                                                                            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   {                                                                                           â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ     "query_type": "metric|lookup|filter|extrema|rank|list|aggregation|comparison|%|trend",   â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ     "table": "Day_Wise_Sales_Table1",                                                         â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ     "aggregation_function": "SUM",                                                            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ     "aggregation_column": "Gross sales",                                                      â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ     "filters": [{"column": "Day", "operator": "LIKE", "value": "%Monday%"}]                   â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   }                                                                                           â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”‚ â•‘
â•‘  â”‚                                           â”‚                                                         â”‚ â•‘
â•‘  â”‚                                           â–¼                                                         â”‚ â•‘
â•‘  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚ â•‘
â•‘  â”‚    â”ƒ  STAGE 3: VALIDATION LAYER                                            âœ… validation_layer/ â”ƒ   â”‚ â•‘
â•‘  â”‚    â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   JSON Plan â”€â”€â”€â”€â–º plan_validator.py â”€â”€â”€â”€â–º Validation Checks                                  â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                  â”‚                      â”‚                                            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                  â–¼                      â–¼                                            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚         â”‚  âœ“ JSON Schema validation (plan_schema.json)     â”‚                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚         â”‚  âœ“ Table exists in DuckDB?                       â”‚                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚         â”‚  âœ“ Columns exist in table?                       â”‚                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚         â”‚  âœ“ Data types compatible?                        â”‚                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚         â”‚  âœ“ Filter values valid?                          â”‚                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                  â”‚                                                                   â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                  â–¼                                                                   â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚    â”‚ rejection_handlerâ”‚        â”‚     join_rules.py      â”‚                           â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚    â”‚ (Error messages) â”‚        â”‚  (Multi-table joins)   â”‚                           â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                                                                                      â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â–¼                                                                                      â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   Validated Plan OR Rejection with helpful error message                                     â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”‚ â•‘
â•‘  â”‚                                           â”‚                                                         â”‚ â•‘
â•‘  â”‚                                           â–¼                                                         â”‚ â•‘
â•‘  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚ â•‘
â•‘  â”‚    â”ƒ  STAGE 4: EXECUTION LAYER                                             âš¡ execution_layer/ â”ƒ   â”‚ â•‘
â•‘  â”‚    â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   Valid Plan â”€â”€â”€â”€â–º Query Type Router                                                         â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                  â”‚                                                                   â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚    â”‚                                                       â”‚                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â–¼    â–¼                                                       â–¼                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚     executor.py            â”‚           â”‚      advanced_executor.py           â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  (7 Basic Query Types)     â”‚           â”‚   (3 Advanced Query Types)          â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚                                     â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  â€¢ metric (SUM/AVG/COUNT)  â”‚           â”‚  â€¢ comparison (Aug vs Dec)          â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  â€¢ lookup (single row)     â”‚           â”‚    â”œâ”€ Query Period A â”€â”€â–º Value A    â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  â€¢ filter (WHERE clause)   â”‚           â”‚    â”œâ”€ Query Period B â”€â”€â–º Value B    â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  â€¢ extrema_lookup (MIN/MAX)â”‚           â”‚    â””â”€ Calculate diff/% change       â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  â€¢ rank (ORDER BY + LIMIT) â”‚           â”‚                                     â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  â€¢ list (show all rows)    â”‚           â”‚  â€¢ percentage (top 10 = X% of total)â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚  â€¢ aggregation_on_subset   â”‚           â”‚    â”œâ”€ Query numerator (subset)      â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚    â”œâ”€ Query denominator (total)     â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚    â””â”€ Calculate percentage          â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚                                     â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚  â€¢ trend (sales going up/down?)     â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚    â”œâ”€ Query time series             â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚    â”œâ”€ Linear regression slope       â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â”‚                            â”‚           â”‚    â””â”€ Determine direction           â”‚            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                 â”‚                                           â”‚                                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                 â””â”€â”€â”€â”€â–ºâ”‚   sql_compiler.py            â”‚â—„â”€â”€â”€â”€â”€â”˜                                 â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚   (Plan â†’ SQL Templates)     â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                      â”‚                                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                      â–¼                                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚        DuckDB                â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚   (In-Memory Analytics)      â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚                              â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚   SELECT SUM("Gross sales")  â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚   FROM Day_Wise_Sales_Table1 â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚   WHERE Day LIKE '%Monday%'  â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                      â”‚                                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                      â–¼                                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚     query_healer.py          â”‚ â—„â”€â”€â”€ On Error                         â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â”‚  (Fuzzy match + auto-retry)  â”‚                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                      â”‚                                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                      â–¼                                                        â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   DataFrame Result + Metadata (aggregation type, calculation results, analysis)              â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”‚ â•‘
â•‘  â”‚                                           â”‚                                                         â”‚ â•‘
â•‘  â”‚                                           â–¼                                                         â”‚ â•‘
â•‘  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚ â•‘
â•‘  â”‚    â”ƒ  STAGE 5: EXPLANATION LAYER                                        ğŸ’¬ explanation_layer/ â”ƒ   â”‚ â•‘
â•‘  â”‚    â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   DataFrame â”€â”€â”€â”€â–º explainer_client.py â”€â”€â”€â”€â–º Gemini 2.0 Flash â”€â”€â”€â”€â–º Natural Language         â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                   â”‚                      â”‚                      â”‚                    â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                   â–¼                      â–¼                      â–¼                    â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚          â”‚explanation_    â”‚     â”‚ Singleton LLM  â”‚     â”‚ Multi-language  â”‚          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚          â”‚prompt.py       â”‚     â”‚ (Cached model  â”‚     â”‚ Support         â”‚          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚          â”‚(Instructions)  â”‚     â”‚  saves 2-4s)   â”‚     â”‚ (EN/Tamil)      â”‚          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â”‚                                                                                      â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ        â–¼                                                                                      â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   "The total gross sales for Monday is â‚¹1,234,567"                                           â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   "ğŸ“ˆ Sales increased by 23.5% from August to December"                                      â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ   "Top 10 items contribute 65.3% of total sales"                                             â”ƒ   â”‚ â•‘
â•‘  â”‚    â”ƒ                                                                                               â”ƒ   â”‚ â•‘
â•‘  â”‚    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”‚ â•‘
â•‘  â”‚                                                                                                      â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                           â”‚                                                              â•‘
â•‘                                           â–¼                                                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                        ğŸ”Š VOICE OUTPUT (Optional)                                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                           â•‘
â•‘    Explanation Text â”€â”€â”€â”€â–º voice_utils.py â”€â”€â”€â”€â–º ElevenLabs TTS API â”€â”€â”€â”€â–º Audio Stream â”€â”€â”€â”€â–º ğŸ”ˆ Speaker   â•‘
â•‘                                â”‚                       â”‚                                                  â•‘
â•‘                                â–¼                       â–¼                                                  â•‘
â•‘                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â•‘
â•‘                       â”‚  tts_cache.py  â”‚      â”‚ Multilingual   â”‚                                         â•‘
â•‘                       â”‚ (Audio caching)â”‚      â”‚ v2 Voice Model â”‚                                         â•‘
â•‘                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â•‘
â•‘                                                                                                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                        ğŸ“¤ FINAL RESPONSE                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                           â•‘
â•‘    {                                                                                                      â•‘
â•‘      "success": true,                                                                                     â•‘
â•‘      "explanation": "The total gross sales for Monday is â‚¹1,234,567",                                    â•‘
â•‘      "data": [{"Gross sales": 1234567}],                                                                 â•‘
â•‘      "plan": {"query_type": "aggregation_on_subset", "table": "Day_Wise_Sales", ...},                   â•‘
â•‘      "schema_context": "Table: Day_Wise_Sales_Table1 | Columns: Date, Day, Gross sales, Orders"         â•‘
â•‘    }                                                                                                      â•‘
â•‘                                                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### External Services & Tools

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                        ğŸ”§ EXTERNAL SERVICES                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚    Google Gemini    â”‚    â”‚    Google Sheets    â”‚    â”‚     ElevenLabs      â”‚    â”‚    ChromaDB     â”‚   â”‚
â”‚   â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚    â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚    â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚    â”‚    â•â•â•â•â•â•â•â•â•    â”‚   â”‚
â”‚   â”‚                     â”‚    â”‚                     â”‚    â”‚                     â”‚    â”‚                 â”‚   â”‚
â”‚   â”‚  â€¢ gemini-2.0-flash â”‚    â”‚  â€¢ Service Account  â”‚    â”‚  â€¢ Scribe v2 (STT)  â”‚    â”‚  â€¢ Embeddings   â”‚   â”‚
â”‚   â”‚    (Planning)       â”‚    â”‚    Authentication   â”‚    â”‚  â€¢ Multilingual v2  â”‚    â”‚  â€¢ Semantic     â”‚   â”‚
â”‚   â”‚  â€¢ gemini-1.5-flash â”‚    â”‚  â€¢ Sheet Data API   â”‚    â”‚    (TTS)            â”‚    â”‚    Search       â”‚   â”‚
â”‚   â”‚    (Translation)    â”‚    â”‚  â€¢ Read-only access â”‚    â”‚  â€¢ Voice ID:        â”‚    â”‚  â€¢ Persistence  â”‚   â”‚
â”‚   â”‚  â€¢ Temperature: 0.0 â”‚    â”‚                     â”‚    â”‚    cgSgspJ2msm...   â”‚    â”‚    to disk      â”‚   â”‚
â”‚   â”‚                     â”‚    â”‚                     â”‚    â”‚                     â”‚    â”‚                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                          â”‚                          â”‚                        â”‚              â”‚
â”‚            â”‚                          â”‚                          â”‚                        â”‚              â”‚
â”‚            â–¼                          â–¼                          â–¼                        â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                         DuckDB                                                    â”‚   â”‚
â”‚   â”‚                              In-Memory Columnar Analytics Engine                                  â”‚   â”‚
â”‚   â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚   â”‚
â”‚   â”‚                                                                                                   â”‚   â”‚
â”‚   â”‚   â€¢ Loads Google Sheets data into memory                                                          â”‚   â”‚
â”‚   â”‚   â€¢ 65+ tables from 19 sheets auto-detected                                                       â”‚   â”‚
â”‚   â”‚   â€¢ SQL execution < 100ms for most queries                                                        â”‚   â”‚
â”‚   â”‚   â€¢ Persisted to: backend/data_sources/snapshots/latest.duckdb                                   â”‚   â”‚
â”‚   â”‚                                                                                                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Ingestion Flow (One-Time Setup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ğŸ“¥ DATA INGESTION PIPELINE                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                           â”‚
â”‚   Google Sheet URL                                                                                        â”‚
â”‚        â”‚                                                                                                  â”‚
â”‚        â–¼                                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚   connector.py  â”‚â”€â”€â”€â”€â–ºâ”‚table_detection.pyâ”‚â”€â”€â”€â”€â–ºâ”‚snapshot_loader â”‚â”€â”€â”€â”€â–ºâ”‚embedding_builderâ”‚            â”‚
â”‚   â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚            â”‚
â”‚   â”‚ â€¢ Fetch sheets  â”‚     â”‚ â€¢ Multi-table   â”‚     â”‚ â€¢ Create DuckDBâ”‚     â”‚ â€¢ Generate      â”‚            â”‚
â”‚   â”‚ â€¢ Type inferenceâ”‚     â”‚   detection     â”‚     â”‚   snapshots     â”‚     â”‚   embeddings    â”‚            â”‚
â”‚   â”‚ â€¢ Service acct  â”‚     â”‚ â€¢ Header detect â”‚     â”‚ â€¢ Persist to   â”‚     â”‚ â€¢ Store in      â”‚            â”‚
â”‚   â”‚                 â”‚     â”‚ â€¢ Clean data    â”‚     â”‚   disk          â”‚     â”‚   ChromaDB      â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚        â”‚                          â”‚                       â”‚                       â”‚                       â”‚
â”‚        â–¼                          â–¼                       â–¼                       â–¼                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                              Generated Artifacts                                                  â”‚    â”‚
â”‚   â”‚                                                                                                   â”‚    â”‚
â”‚   â”‚   ğŸ“ backend/data_sources/snapshots/                                                              â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ latest.duckdb          # In-memory database file                                        â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ table_metadata.json    # 65 tables with row counts                                      â”‚    â”‚
â”‚   â”‚      â””â”€â”€ sheet_state.json       # Hash-based change detection                                    â”‚    â”‚
â”‚   â”‚                                                                                                   â”‚    â”‚
â”‚   â”‚   ğŸ“ backend/schema_store/      # ChromaDB vector embeddings                                      â”‚    â”‚
â”‚   â”‚                                                                                                   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Project Structure

### Complete Directory Tree

```
kiwio/
â”œâ”€â”€ README.md                         # This documentation file
â”‚
â”œâ”€â”€ backend/                          # Python FastAPI Backend (Port 8000)
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                          # REST API Layer
â”‚   â”‚   â”œâ”€â”€ __init__.py               # Package initialization
â”‚   â”‚   â”œâ”€â”€ main.py                   # FastAPI app, CORS, route definitions
â”‚   â”‚   â”œâ”€â”€ models.py                 # Pydantic request/response schemas
â”‚   â”‚   â””â”€â”€ services.py               # Main orchestrator - integrates all layers
â”‚   â”‚
â”‚   â”œâ”€â”€ planning_layer/               # LLM Query Planning
â”‚   â”‚   â”œâ”€â”€ planner_client.py         # Gemini API client for JSON plan generation
â”‚   â”‚   â”œâ”€â”€ planner_prompt.py         # System prompts with 10 query type examples
â”‚   â”‚   â”œâ”€â”€ plan_schema.json          # JSON Schema for plan validation
â”‚   â”‚   â”œâ”€â”€ table_router.py           # Intelligent table selection based on query
â”‚   â”‚   â””â”€â”€ entity_extractor.py       # Named entity extraction (names, dates, etc.)
â”‚   â”‚
â”‚   â”œâ”€â”€ validation_layer/             # Plan Validation
â”‚   â”‚   â”œâ”€â”€ plan_validator.py         # Schema, type, rule validation
â”‚   â”‚   â”œâ”€â”€ rejection_handler.py      # User-friendly error message generation
â”‚   â”‚   â””â”€â”€ join_rules.py             # Multi-table join validation rules
â”‚   â”‚
â”‚   â”œâ”€â”€ execution_layer/              # SQL Execution
â”‚   â”‚   â”œâ”€â”€ executor.py               # Standard query execution (7 basic types)
â”‚   â”‚   â”œâ”€â”€ advanced_executor.py      # Complex queries (comparison, percentage, trend)
â”‚   â”‚   â”œâ”€â”€ sql_compiler.py           # Template-based Plan â†’ SQL compilation
â”‚   â”‚   â””â”€â”€ query_healer.py           # Self-healing for failed queries
â”‚   â”‚
â”‚   â”œâ”€â”€ explanation_layer/            # Natural Language Generation
â”‚   â”‚   â”œâ”€â”€ explainer_client.py       # Gemini-based result explanation
â”‚   â”‚   â””â”€â”€ explanation_prompt.py     # System prompts for explanations
â”‚   â”‚
â”‚   â”œâ”€â”€ schema_intelligence/          # Semantic Schema Retrieval
â”‚   â”‚   â”œâ”€â”€ chromadb_client.py        # Vector store CRUD operations
â”‚   â”‚   â”œâ”€â”€ embedding_builder.py      # Creates embeddings from schema
â”‚   â”‚   â”œâ”€â”€ hybrid_retriever.py       # Semantic + keyword search
â”‚   â”‚   â”œâ”€â”€ profile_store.py          # Stores table profiles with statistics
â”‚   â”‚   â”œâ”€â”€ data_profiler.py          # Computes column statistics
â”‚   â”‚   â””â”€â”€ schema_extractor.py       # Extracts schema from DataFrames
â”‚   â”‚
â”‚   â”œâ”€â”€ data_sources/
â”‚   â”‚   â”œâ”€â”€ gsheet/                   # Google Sheets Integration
â”‚   â”‚   â”‚   â”œâ”€â”€ connector.py          # Sheet fetching, type inference
â”‚   â”‚   â”‚   â”œâ”€â”€ table_detection.py    # Multi-table detection algorithm
â”‚   â”‚   â”‚   â”œâ”€â”€ change_detector.py    # Hash-based change tracking
â”‚   â”‚   â”‚   â”œâ”€â”€ snapshot_loader.py    # DuckDB snapshot management
â”‚   â”‚   â”‚   â”œâ”€â”€ sheet_hasher.py       # SHA-256 hashing utilities
â”‚   â”‚   â”‚   â””â”€â”€ wide_format_transformer.py  # Pivoted table handling
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ snapshots/                # Persisted Data (auto-generated)
â”‚   â”‚       â”œâ”€â”€ latest.duckdb         # DuckDB database file
â”‚   â”‚       â”œâ”€â”€ table_metadata.json   # Table registry with row counts
â”‚   â”‚       â””â”€â”€ sheet_state.json      # Change detection state
â”‚   â”‚
â”‚   â”œâ”€â”€ analytics_engine/             # SQL Analytics
â”‚   â”‚   â”œâ”€â”€ duckdb_manager.py         # DuckDB connection pooling
â”‚   â”‚   â”œâ”€â”€ metric_registry.py        # Pre-defined metric definitions
â”‚   â”‚   â”œâ”€â”€ sanity_checks.py          # Result validation (empty, types)
â”‚   â”‚   â””â”€â”€ sql_templates/            # SQL template files
â”‚   â”‚       â””â”€â”€ .gitkeep
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                        # Cross-Cutting Utilities
â”‚   â”‚   â”œâ”€â”€ translation.py            # Tamil â†” English via Gemini
â”‚   â”‚   â”œâ”€â”€ voice_utils.py            # ElevenLabs STT/TTS integration
â”‚   â”‚   â”œâ”€â”€ permanent_memory.py       # JSON-based user preference storage
â”‚   â”‚   â”œâ”€â”€ greeting_detector.py      # Detects casual greetings vs queries
â”‚   â”‚   â”œâ”€â”€ memory_detector.py        # Detects "remember my name" intents
â”‚   â”‚   â”œâ”€â”€ personality.py            # Thara AI personality traits
â”‚   â”‚   â”œâ”€â”€ onboarding.py             # New user onboarding flow
â”‚   â”‚   â”œâ”€â”€ query_context.py          # Conversation history management
â”‚   â”‚   â”œâ”€â”€ conversation_manager.py   # Multi-turn conversation state
â”‚   â”‚   â”œâ”€â”€ context_resolver.py       # Pronoun/reference resolution
â”‚   â”‚   â”œâ”€â”€ query_cache.py            # Query result caching
â”‚   â”‚   â”œâ”€â”€ question_cache.py         # Similar question detection
â”‚   â”‚   â”œâ”€â”€ tts_cache.py              # TTS audio caching
â”‚   â”‚   â”œâ”€â”€ config_loader.py          # YAML configuration loader
â”‚   â”‚   â”œâ”€â”€ gsheet_oauth.py           # Google OAuth flow handler
â”‚   â”‚   â”œâ”€â”€ supabase_auth.py          # Supabase auth integration
â”‚   â”‚   â””â”€â”€ auth_integration.py       # Auth utilities
â”‚   â”‚
â”‚   â”œâ”€â”€ table detector/               # Standalone Table Detection Module
â”‚   â”‚   â”œâ”€â”€ config.py                 # Detection configuration
â”‚   â”‚   â”œâ”€â”€ custom_detector.py        # Custom table detection logic
â”‚   â”‚   â”œâ”€â”€ table_detector.py         # Main detection algorithm
â”‚   â”‚   â”œâ”€â”€ table_cleaner.py          # Data cleaning utilities
â”‚   â”‚   â”œâ”€â”€ gsheet_loader.py          # Sheet data loader
â”‚   â”‚   â”œâ”€â”€ sheet_ingestion.py        # Full ingestion pipeline
â”‚   â”‚   â”œâ”€â”€ extract_tables.py         # Table extraction utilities
â”‚   â”‚   â””â”€â”€ extracted_tables.json     # Detection output cache
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                       # Configuration Files
â”‚   â”‚   â”œâ”€â”€ settings.yaml             # Main application configuration
â”‚   â”‚   â””â”€â”€ metric_definitions.yaml   # Metric definitions
â”‚   â”‚
â”‚   â”œâ”€â”€ schema_store/                 # ChromaDB Vector Store (auto-generated)
â”‚   â”‚   â””â”€â”€ [uuid]/                   # Embedding collections
â”‚   â”‚       â”œâ”€â”€ data_level0.bin
â”‚   â”‚       â”œâ”€â”€ header.bin
â”‚   â”‚       â”œâ”€â”€ length.bin
â”‚   â”‚       â””â”€â”€ link_lists.bin
â”‚   â”‚
â”‚   â”œâ”€â”€ credentials/                  # (gitignored)
â”‚   â”‚   â””â”€â”€ service_account.json      # Google service account key
â”‚   â”‚
â”‚   â”œâ”€â”€ requirements.txt              # Python dependencies
â”‚   â”œâ”€â”€ supabase_schema.sql           # Database schema for auth
â”‚   â”œâ”€â”€ run_query.py                  # CLI query testing tool
â”‚   â”œâ”€â”€ verify_fix.py                 # Fix verification script
â”‚   â”œâ”€â”€ .gitignore                    # Git ignore rules
â”‚   â””â”€â”€ .env                          # Environment variables (gitignored)
â”‚
â””â”€â”€ frontend/                         # Next.js 15 Frontend (Port 3000)
    â”‚
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ app/                      # Next.js App Router
    â”‚   â”‚   â”œâ”€â”€ layout.tsx            # Root layout with providers
    â”‚   â”‚   â”œâ”€â”€ page.tsx              # Entry point (main page)
    â”‚   â”‚   â”œâ”€â”€ globals.css           # Global styles (Tailwind)
    â”‚   â”‚   â”œâ”€â”€ global-error.tsx      # Error boundary
    â”‚   â”‚   â””â”€â”€ auth/                 # Auth callback routes
    â”‚   â”‚       â”œâ”€â”€ callback/
    â”‚   â”‚       â”‚   â””â”€â”€ page.tsx      # OAuth callback handler
    â”‚   â”‚       â””â”€â”€ sheets-callback/
    â”‚   â”‚           â””â”€â”€ page.tsx      # Sheets OAuth callback
    â”‚   â”‚
    â”‚   â”œâ”€â”€ components/               # React Components
    â”‚   â”‚   â”œâ”€â”€ ChatScreen.tsx        # Main chat interface (~1000 lines)
    â”‚   â”‚   â”œâ”€â”€ DatasetConnection.tsx # Sheet URL connection modal (~900 lines)
    â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx     # Message rendering with metadata
    â”‚   â”‚   â”œâ”€â”€ VoiceVisualizer.tsx   # Audio waveform animation
    â”‚   â”‚   â”œâ”€â”€ QueryPlanViewer.tsx   # Query plan JSON visualization
    â”‚   â”‚   â”œâ”€â”€ AuthScreen.tsx        # Login/signup screen
    â”‚   â”‚   â”œâ”€â”€ ChatInput.tsx         # Text input component
    â”‚   â”‚   â”œâ”€â”€ ErrorReporter.tsx     # Error display component
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ chat/                 # Chat sub-components
    â”‚   â”‚   â”‚   â”œâ”€â”€ ChatHeader.tsx    # Header with controls
    â”‚   â”‚   â”‚   â”œâ”€â”€ ChatsSidebar.tsx  # Multi-chat sidebar
    â”‚   â”‚   â”‚   â”œâ”€â”€ ChatInput.tsx     # Input field
    â”‚   â”‚   â”‚   â”œâ”€â”€ MessageList.tsx   # Message container
    â”‚   â”‚   â”‚   â”œâ”€â”€ VoiceInterface.tsx# Voice mode UI
    â”‚   â”‚   â”‚   â””â”€â”€ index.ts          # Barrel exports
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ auth/                 # Auth components
    â”‚   â”‚   â”‚   â””â”€â”€ GoogleAuthButton.tsx
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ ui/                   # Radix UI Components (58 files)
    â”‚   â”‚       â”œâ”€â”€ accordion.tsx
    â”‚   â”‚       â”œâ”€â”€ alert-dialog.tsx
    â”‚   â”‚       â”œâ”€â”€ alert.tsx
    â”‚   â”‚       â”œâ”€â”€ button.tsx
    â”‚   â”‚       â”œâ”€â”€ card.tsx
    â”‚   â”‚       â”œâ”€â”€ dialog.tsx
    â”‚   â”‚       â”œâ”€â”€ dropdown-menu.tsx
    â”‚   â”‚       â”œâ”€â”€ input.tsx
    â”‚   â”‚       â”œâ”€â”€ select.tsx
    â”‚   â”‚       â”œâ”€â”€ table.tsx
    â”‚   â”‚       â”œâ”€â”€ tabs.tsx
    â”‚   â”‚       â”œâ”€â”€ toast.tsx
    â”‚   â”‚       â”œâ”€â”€ tooltip.tsx
    â”‚   â”‚       â””â”€â”€ ... (45 more)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ services/
    â”‚   â”‚   â””â”€â”€ api.ts                # Backend HTTP client
    â”‚   â”‚
    â”‚   â”œâ”€â”€ lib/
    â”‚   â”‚   â”œâ”€â”€ hooks.ts              # useAppState hook (state management)
    â”‚   â”‚   â”œâ”€â”€ types.ts              # TypeScript interfaces
    â”‚   â”‚   â”œâ”€â”€ utils.ts              # Utility functions (cn, etc.)
    â”‚   â”‚   â”œâ”€â”€ constants.ts          # App constants
    â”‚   â”‚   â””â”€â”€ hooks/
    â”‚   â”‚       â””â”€â”€ use-mobile.tsx    # Mobile detection hook
    â”‚   â”‚
    â”‚   â”œâ”€â”€ hooks/
    â”‚   â”‚   â”œâ”€â”€ useVoiceRecording.ts  # Voice recording logic
    â”‚   â”‚   â”œâ”€â”€ useTextToSpeech.ts    # TTS playback logic
    â”‚   â”‚   â””â”€â”€ use-mobile.ts         # Mobile detection
    â”‚   â”‚
    â”‚   â””â”€â”€ visual-edits/
    â”‚       â””â”€â”€ VisualEditsMessenger.tsx
    â”‚
    â”œâ”€â”€ public/                       # Static assets
    â”œâ”€â”€ package.json                  # Node dependencies
    â”œâ”€â”€ package-lock.json             # Dependency lock file
    â”œâ”€â”€ next.config.ts                # Next.js configuration
    â”œâ”€â”€ tailwind.config.ts            # Tailwind CSS config
    â”œâ”€â”€ tsconfig.json                 # TypeScript config
    â”œâ”€â”€ postcss.config.mjs            # PostCSS config
    â”œâ”€â”€ components.json               # shadcn/ui config
    â””â”€â”€ .env.local                    # Environment variables (gitignored)
```

---

## Backend Architecture

### Layer-by-Layer Breakdown

#### 1. API Layer (`api/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `main.py` | FastAPI app, CORS, routes | `load_dataset()`, `process_query()`, `transcribe()`, `text_to_speech()` |
| `models.py` | Pydantic schemas | `LoadDataRequest`, `ProcessQueryRequest`, `ProcessQueryResponse` |
| `services.py` | Main orchestrator | `load_dataset_service()`, `process_query_service()` |

#### 2. Planning Layer (`planning_layer/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `planner_client.py` | Gemini API client | `generate_plan()` - Returns JSON query plan |
| `planner_prompt.py` | System prompts | `PLANNER_SYSTEM_PROMPT`, `build_dynamic_schema_prompt()` |
| `plan_schema.json` | JSON Schema | Defines 10 query types with all fields |
| `table_router.py` | Smart table selection | `route_query()` - Selects best table for query |
| `entity_extractor.py` | NER extraction | `extract_entities()` - Names, dates, numbers |

#### 3. Validation Layer (`validation_layer/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `plan_validator.py` | Plan validation | `validate_plan()` - Schema, table, column checks |
| `rejection_handler.py` | Error messages | `format_rejection()` - User-friendly errors |
| `join_rules.py` | Join validation | `validate_joins()` - Multi-table rules |

#### 4. Execution Layer (`execution_layer/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `executor.py` | Standard execution | `execute_plan()` - Routes to SQL compiler |
| `advanced_executor.py` | Complex queries | `execute_comparison()`, `execute_percentage()`, `execute_trend()` |
| `sql_compiler.py` | SQL generation | `compile_sql()` - Template-based |
| `query_healer.py` | Self-healing | `heal_query()` - Fuzzy column matching |

#### 5. Explanation Layer (`explanation_layer/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `explainer_client.py` | Result explanation | `explain_results()` - Gemini-powered NL generation |
| `explanation_prompt.py` | System prompts | `EXPLANATION_SYSTEM_PROMPT` |

#### 6. Schema Intelligence (`schema_intelligence/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `chromadb_client.py` | Vector store | `add_documents()`, `query()`, `delete_collection()` |
| `embedding_builder.py` | Schema embeddings | `build_schema_documents()` |
| `hybrid_retriever.py` | Search | `retrieve()` - Semantic + keyword |
| `profile_store.py` | Table profiles | `store_profile()`, `get_profile()` |
| `data_profiler.py` | Column stats | `profile_table()` - Min, max, unique, etc. |

#### 7. Data Sources (`data_sources/gsheet/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `connector.py` | Sheets API | `fetch_sheets_with_tables()` - Returns `DetectedTable[]` |
| `table_detection.py` | Table detection | `detect_tables()` - Splits by empty rows |
| `change_detector.py` | Change tracking | `needs_refresh()` - Hash comparison |
| `snapshot_loader.py` | DuckDB snapshots | `load_snapshot()` - Creates DuckDB tables |
| `sheet_hasher.py` | Hashing | `hash_sheet()` - SHA-256 |

#### 8. Analytics Engine (`analytics_engine/`)

| File | Purpose | Key Functions |
|------|---------|---------------|
| `duckdb_manager.py` | Connection pool | `DuckDBManager.execute()` - Query execution |
| `metric_registry.py` | Metrics | `MetricRegistry.get()` - Pre-defined metrics |
| `sanity_checks.py` | Validation | `check_results()` - Empty, type checks |

---

## Frontend Architecture

### Component Architecture

```
App (layout.tsx)
â””â”€â”€ ThemeProvider (next-themes)
    â””â”€â”€ ChatScreen.tsx (Main Interface)
        â”œâ”€â”€ ChatHeader
        â”‚   â”œâ”€â”€ Sidebar Toggle Button
        â”‚   â”œâ”€â”€ Dataset Status â†’ DatasetConnection Modal
        â”‚   â”œâ”€â”€ Voice/Chat Mode Toggle
        â”‚   â””â”€â”€ User Dropdown Menu
        â”‚
        â”œâ”€â”€ ChatsSidebar (AnimatePresence)
        â”‚   â”œâ”€â”€ New Chat Button
        â”‚   â”œâ”€â”€ Chat List
        â”‚   â”‚   â””â”€â”€ Chat Item (title, count, delete)
        â”‚   â””â”€â”€ Overlay (click to close)
        â”‚
        â”œâ”€â”€ Main Content Area
        â”‚   â”œâ”€â”€ Voice Mode (default)
        â”‚   â”‚   â”œâ”€â”€ VoiceVisualizer (animated bars)
        â”‚   â”‚   â”œâ”€â”€ Microphone Button
        â”‚   â”‚   â”œâ”€â”€ Status Text
        â”‚   â”‚   â””â”€â”€ Info Panels (Plan/Data/Schema)
        â”‚   â”‚
        â”‚   â””â”€â”€ Chat Mode (toggle)
        â”‚       â”œâ”€â”€ MessageList (auto-scroll)
        â”‚       â”‚   â””â”€â”€ MessageBubble[]
        â”‚       â”‚       â”œâ”€â”€ User Message
        â”‚       â”‚       â””â”€â”€ Assistant Message
        â”‚       â”‚           â”œâ”€â”€ Explanation
        â”‚       â”‚           â”œâ”€â”€ Data Table
        â”‚       â”‚           â””â”€â”€ Query Plan
        â”‚       â””â”€â”€ ChatInput
        â”‚           â”œâ”€â”€ Text Input
        â”‚           â””â”€â”€ Send Button
        â”‚
        â””â”€â”€ Modals
            â”œâ”€â”€ DatasetConnection
            â”‚   â”œâ”€â”€ URL Input
            â”‚   â”œâ”€â”€ Connect Button
            â”‚   â”œâ”€â”€ Stats Display
            â”‚   â””â”€â”€ Table List
            â””â”€â”€ Settings
                â””â”€â”€ Theme Selector
```

### State Management

**Hook:** `useAppState()` in `lib/hooks.ts`

```typescript
interface AppState {
  auth: {
    isAuthenticated: boolean;
    username: string | null;
  };
  messages: Message[];
  chatTabs: ChatTab[];
  activeChatId: string | null;
  config: {
    googleSheetUrl: string | null;
  };
}

interface ChatTab {
  id: string;
  title: string;
  messages: Message[];
  createdAt: string;
  updatedAt: string;
  datasetUrl?: string;
  datasetStatus?: 'idle' | 'loading' | 'ready' | 'error';
  datasetStats?: DatasetStats;
}
```

**LocalStorage Keys:**
- `kiwi_assistant_auth` - Authentication state
- `kiwi_assistant_chat` - Current chat messages
- `kiwi_assistant_tabs` - All chat tabs
- `kiwi_assistant_config` - App configuration

---

## Query Types

Kiwi supports **10 query types** covering all analytics scenarios:

### Basic Query Types (7)

| Type | Description | Example | SQL Pattern |
|------|-------------|---------|-------------|
| `metric` | Aggregations | "Total sales?" | `SELECT SUM(col) FROM table` |
| `lookup` | Single row | "Sales for Carrot?" | `SELECT * FROM table WHERE x LIKE '%Carrot%' LIMIT 1` |
| `filter` | Multiple rows | "Sales above 10000?" | `SELECT * FROM table WHERE col > 10000` |
| `extrema_lookup` | Min/Max row | "Highest sales day?" | `SELECT * FROM table ORDER BY col DESC LIMIT 1` |
| `rank` | Ordered list | "Top 5 items?" | `SELECT * FROM table ORDER BY col DESC LIMIT 5` |
| `list` | All rows | "All categories?" | `SELECT * FROM table LIMIT 100` |
| `aggregation_on_subset` | Subset agg | "Avg of top 5?" | `SELECT AVG(col) FROM (SELECT col ORDER BY col DESC LIMIT 5)` |

### Advanced Query Types (3)

| Type | Description | Example | Execution |
|------|-------------|---------|-----------|
| `comparison` | Compare periods | "August vs December?" | 2 queries + diff calculation |
| `percentage` | Contribution % | "Top 10 items %?" | Numerator/denominator queries |
| `trend` | Time patterns | "Sales trending?" | Time series + linear regression |

### Advanced Query Execution Details

#### Comparison Query
```python
# Question: "Are weekends better than weekdays?"

Plan:
{
  "query_type": "comparison",
  "comparison": {
    "period_a": {
      "label": "Weekdays",
      "filters": [
        {"column": "Day", "operator": "LIKE", "value": "%Monday%"},
        {"column": "Day", "operator": "LIKE", "value": "%Tuesday%"},
        ...
      ],
      "aggregation": "AVG"
    },
    "period_b": {
      "label": "Weekends",
      "filters": [
        {"column": "Day", "operator": "LIKE", "value": "%Saturday%"},
        {"column": "Day", "operator": "LIKE", "value": "%Sunday%"}
      ],
      "aggregation": "AVG"
    },
    "compare_type": "difference"
  }
}

Execution:
1. Query weekday avg: SELECT AVG(col) WHERE (Day LIKE '%Monday%' OR Day LIKE '%Tuesday%' ...)
2. Query weekend avg: SELECT AVG(col) WHERE (Day LIKE '%Saturday%' OR Day LIKE '%Sunday%')
3. Calculate: difference, percentage_change, direction

Result: "ğŸ“ˆ Weekends perform 46.7% better than weekdays"
```

#### Percentage Query
```python
# Question: "What % comes from top 10 items?"

Plan:
{
  "query_type": "percentage",
  "percentage": {
    "numerator": {
      "column": "Gross sales",
      "order_by": [["Gross sales", "DESC"]],
      "limit": 10,
      "aggregation": "SUM"
    },
    "denominator": {
      "column": "Gross sales",
      "aggregation": "SUM"
    }
  }
}

Execution:
1. Query top 10 sum: SELECT SUM(col) FROM (SELECT col ORDER BY col DESC LIMIT 10)
2. Query total sum: SELECT SUM(col) FROM table
3. Calculate: (numerator / denominator) * 100

Result: "Top 10 items contribute 65.3% of total sales"
```

#### Trend Query
```python
# Question: "How are daily sales trending?"

Plan:
{
  "query_type": "trend",
  "trend": {
    "date_column": "Date",
    "value_column": "Gross sales",
    "aggregation": "SUM",
    "analysis_type": "direction"
  }
}

Execution:
1. Query time series: SELECT Date, SUM(col) GROUP BY Date ORDER BY Date
2. Calculate linear regression slope
3. Determine direction and confidence

Result: "ğŸ“ˆ Sales are trending upward - from 10,000 to 15,000 (50% increase)"
```

---

## Data Flow

### Query Processing Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT                                â”‚
â”‚                   (Voice or Text, EN/Tamil)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PRE-PROCESSING                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Phonetic    â”‚  â”‚ Greeting    â”‚  â”‚ Memory Detection        â”‚  â”‚
â”‚  â”‚ Corrections â”‚  â”‚ Detection   â”‚  â”‚ ("Call me John")        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Translation (if Tamil): Gemini 1.5 Flash â†’ English        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SCHEMA RETRIEVAL                              â”‚
â”‚  ChromaDB Query (top_k=50) â†’ Schema Context                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PLANNING                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Table       â”‚  â”‚ Entity      â”‚  â”‚ Gemini Planner          â”‚  â”‚
â”‚  â”‚ Router      â”‚  â”‚ Extractor   â”‚  â”‚ (JSON Plan)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      VALIDATION                                  â”‚
â”‚  JSON Schema â†’ Table Exists â†’ Columns Exist â†’ Type Check        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EXECUTION                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Query Type Router                                          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Basic (7 types) â†’ SQL Compiler â†’ DuckDB               â”‚  â”‚
â”‚  â”‚ â””â”€â”€ Advanced (3 types) â†’ Multi-Query Executor             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Query Healer (on failure): Fuzzy match â†’ Retry            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EXPLANATION                                  â”‚
â”‚  Gemini 2.0 Flash â†’ Natural Language Response                   â”‚
â”‚  Post-Translation (if Tamil) â†’ Tamil Response                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RESPONSE                                   â”‚
â”‚  {success, explanation, data, plan, schema_context}             â”‚
â”‚  Voice Mode: â†’ TTS â†’ Audio Playback                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Setup & Installation

### What You Need (Prerequisites)

Before running Kiwi, you'll need to obtain the following:

| Requirement | Purpose | Where to Get |
|-------------|---------|--------------|
| **Python 3.11+** | Backend runtime | [python.org](https://www.python.org/downloads/) |
| **Node.js 18+** | Frontend runtime | [nodejs.org](https://nodejs.org/) |
| **Gemini API Key** | LLM for query planning & explanation | [Google AI Studio](https://aistudio.google.com/app/apikey) |
| **ElevenLabs API Key** | Voice features (STT/TTS) | [ElevenLabs](https://elevenlabs.io/) â†’ Profile â†’ API Keys |
| **Google Service Account** | Access Google Sheets data | [Google Cloud Console](https://console.cloud.google.com/) |

### Step 1: Get Your API Keys

#### 1.1 Gemini API Key (Required)
1. Go to [Google AI Studio](https://aistudio.google.com/app/apikey)
2. Sign in with your Google account
3. Click **"Create API Key"**
4. Copy and save the key (starts with `AIza...`)

#### 1.2 ElevenLabs API Key (Required for Voice)
1. Go to [ElevenLabs](https://elevenlabs.io/) and create an account
2. Click on your profile icon â†’ **Profile + API Key**
3. Copy the API key (starts with `sk_...`)

> **Note:** ElevenLabs offers a free tier with limited characters/month

#### 1.3 Google Service Account (Required)
1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project (or select existing)
3. Go to **APIs & Services** â†’ **Enable APIs**
4. Search and enable **Google Sheets API**
5. Go to **APIs & Services** â†’ **Credentials**
6. Click **Create Credentials** â†’ **Service Account**
7. Fill in details and click **Create**
8. Skip optional permissions, click **Done**
9. Click on the created service account
10. Go to **Keys** tab â†’ **Add Key** â†’ **Create New Key** â†’ **JSON**
11. Save the downloaded file as `service_account.json`

### Step 2: Clone & Setup Backend

```bash
# Clone the repository
git clone <your-repo-url>
cd kiwio

# Navigate to backend
cd backend

# Create virtual environment
python -m venv venv

# Activate virtual environment
# Windows:
venv\Scripts\activate
# Mac/Linux:
source venv/bin/activate

# Install Python dependencies
pip install -r requirements.txt
```

### Step 3: Configure Backend

```bash
# Create credentials folder
mkdir credentials

# Copy your service_account.json to credentials folder
# Place the file at: backend/credentials/service_account.json

# Create .env file
# Windows:
echo GEMINI_API_KEY=your-gemini-api-key-here > .env
echo ELEVENLABS_API_KEY=your-elevenlabs-api-key-here >> .env

# Mac/Linux:
cat > .env << EOF
GEMINI_API_KEY=your-gemini-api-key-here
ELEVENLABS_API_KEY=your-elevenlabs-api-key-here
EOF
```

**Your `.env` file should look like:**
```env
GEMINI_API_KEY=AIzaSyD...your-key-here
ELEVENLABS_API_KEY=sk_...your-key-here
```

### Step 4: Setup Frontend

```bash
# Open new terminal, navigate to frontend
cd frontend

# Install Node.js dependencies
npm install

# Create environment file
# Windows:
echo NEXT_PUBLIC_API_BASE_URL=http://localhost:8000 > .env.local

# Mac/Linux:
echo "NEXT_PUBLIC_API_BASE_URL=http://localhost:8000" > .env.local
```

### Step 5: Share Your Google Sheet

**Important:** Your Google Sheet must be shared with the service account.

1. Open your Google Sheet
2. Click **Share** button
3. Find the service account email in your `service_account.json`:
   ```json
   "client_email": "your-service@your-project.iam.gserviceaccount.com"
   ```
4. Paste this email and give **Viewer** access
5. Click **Send**

### Step 6: Run the Application

**Terminal 1 - Start Backend:**
```bash
cd backend
venv\Scripts\activate  # Windows
# source venv/bin/activate  # Mac/Linux

python -m uvicorn api.main:app --reload --port 8000
```

**Terminal 2 - Start Frontend:**
```bash
cd frontend
npm run dev
```

### Step 7: Access the App

1. Open browser: **http://localhost:3000**
2. Paste your Google Sheet URL in the connection modal
3. Click **Connect** and wait for data to load
4. Start asking questions!

### Quick Start Checklist

```
âœ… Python 3.11+ installed
âœ… Node.js 18+ installed
âœ… Gemini API key obtained
âœ… ElevenLabs API key obtained
âœ… Google service account JSON downloaded
âœ… backend/.env file created with API keys
âœ… backend/credentials/service_account.json in place
âœ… frontend/.env.local file created
âœ… Google Sheet shared with service account email
âœ… Backend running on port 8000
âœ… Frontend running on port 3000
```

### Common Setup Errors

| Error | Cause | Fix |
|-------|-------|-----|
| `GEMINI_API_KEY not found` | Missing .env file | Create `.env` in backend folder |
| `credentials/service_account.json not found` | Wrong path | Ensure file is in `backend/credentials/` |
| `Google Sheets API has not been enabled` | API not enabled | Enable in Google Cloud Console |
| `The caller does not have permission` | Sheet not shared | Share sheet with service account email |
| `ECONNREFUSED localhost:8000` | Backend not running | Start backend first |
| `Module not found` | Dependencies missing | Run `pip install -r requirements.txt` |

---

## Configuration

### Backend Configuration (`config/settings.yaml`)

```yaml
google_sheets:
  credentials_path: credentials/service_account.json
  spreadsheet_id: <auto-updated-on-connect>

llm:
  provider: gemini
  model: gemini-1.5-flash
  temperature: 0.0
  max_retries: 3
  api_key_env: GEMINI_API_KEY

duckdb:
  snapshot_path: data_sources/snapshots/latest.duckdb

schema_intelligence:
  embedding_model: sentence-transformers/all-MiniLM-L6-v2
  top_k: 50
```

### Environment Variables

**Backend (`.env`):**
```bash
GEMINI_API_KEY=your-gemini-api-key
ELEVENLABS_API_KEY=your-elevenlabs-api-key
ENABLE_AUTH=false
```

**Frontend (`.env.local`):**
```bash
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
```

---

## API Reference

### Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| `POST` | `/api/load-dataset` | Load Google Sheet into system |
| `POST` | `/api/query` | Process natural language query |
| `POST` | `/api/transcribe` | Convert audio to text (STT) |
| `POST` | `/api/text-to-speech` | Convert text to audio (TTS) |
| `GET` | `/api/auth/check` | Check authentication status |
| `GET` | `/api/auth/google-url` | Get Google OAuth URL |
| `GET` | `/api/auth/callback` | OAuth callback handler |

### Load Dataset

```http
POST /api/load-dataset
Content-Type: application/json

{"url": "https://docs.google.com/spreadsheets/d/..."}
```

**Response:**
```json
{
  "success": true,
  "stats": {
    "totalTables": 65,
    "totalRecords": 25000,
    "sheetCount": 19,
    "sheets": {
      "Sales": {"tableCount": 16, "rowCount": 200},
      "Profit": {"tableCount": 12, "rowCount": 150}
    }
  }
}
```

### Process Query

```http
POST /api/query
Content-Type: application/json

{"text": "What is the total sales for December?"}
```

**Response:**
```json
{
  "success": true,
  "explanation": "The total gross sales for December is 1,234,567.",
  "data": [{"Gross sales": 1234567}],
  "plan": {
    "query_type": "aggregation_on_subset",
    "table": "Freshggies_Shopify_Sales_December",
    "aggregation_function": "SUM",
    "aggregation_column": "Gross sales"
  },
  "schema_context": "Table: Freshggies_Shopify_Sales_December...",
  "is_greeting": false,
  "is_memory_storage": false
}
```

---

## Troubleshooting

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| "No data found" | Wrong table selected | Check schema_context, verify table names |
| "Table does not exist" | DuckDB not loaded | Reload dataset |
| "JSON parse error" | LLM returned invalid JSON | Check planner_prompt.py |
| "Empty transcription" | No speech / mic blocked | Check permissions |
| "ChromaDB error" | Missing embeddings | Install sentence-transformers |

### Debug Tips

1. **Enable verbose logging** in `api/services.py`
2. **Check Query Plan** in UI response
3. **Verify DuckDB tables**: `duckdb.connect('latest.duckdb').execute('SHOW TABLES')`
4. **Test ChromaDB**: Check `schema_store/` directory

---

## Performance

| Operation | Time | Notes |
|-----------|------|-------|
| Dataset Load | 5-10s | Google API + Embeddings |
| Query Processing | 2-5s | LLM calls dominate |
| Voice Transcription | 1-2s | ElevenLabs API |
| TTS Generation | 0.5-1s | ElevenLabs API |

**Memory:** ~500MB total (DuckDB ~100MB, ChromaDB ~50MB)

---

## License

MIT License - See LICENSE file for details.

---

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing`)
5. Open a Pull Request

---

## Support

- **Issues:** Create GitHub issue with "bug" or "feature" label
- **Questions:** Create issue with "question" label
- **Documentation:** This README
