{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": [
    "query_type",
    "table"
  ],
  "properties": {
    "query_type": {
      "type": "string",
      "enum": [
        "metric",
        "lookup",
        "filter",
        "extrema_lookup",
        "rank",
        "list",
        "aggregation_on_subset",
        "comparison",
        "percentage",
        "trend",
        "projection"
      ]
    },
    "table": {
      "type": "string"
    },
    "select_columns": {
      "type": [
        "array",
        "null"
      ],
      "items": {
        "type": "string"
      }
    },
    "metrics": {
      "type": [
        "array",
        "null"
      ],
      "items": {
        "type": "string"
      }
    },
    "filters": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "column": {
            "type": "string"
          },
          "operator": {
            "type": "string",
            "enum": [
              "=",
              ">",
              "<",
              ">=",
              "<=",
              "!=",
              "LIKE"
            ]
          },
          "value": {}
        },
        "required": [
          "column",
          "operator",
          "value"
        ]
      }
    },
    "group_by": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "order_by": {
      "type": "array",
      "items": {
        "type": "array",
        "items": [
          {
            "type": "string"
          },
          {
            "type": "string",
            "enum": [
              "ASC",
              "DESC"
            ]
          }
        ]
      }
    },
    "limit": {
      "type": "integer"
    },
    "aggregation_function": {
      "type": "string"
    },
    "aggregation_column": {
      "type": [
        "string",
        "null"
      ]
    },
    "subset_filters": {
      "type": "array"
    },
    "subset_order_by": {
      "type": "array"
    },
    "subset_limit": {
      "type": [
        "integer",
        "null"
      ]
    },
    "comparison": {
      "type": ["object", "null"],
      "description": "For comparison query type - compare two periods or values",
      "properties": {
        "period_a": {
          "type": "object",
          "properties": {
            "label": { "type": "string" },
            "table": { "type": "string" },
            "column": { "type": "string" },
            "filters": { "type": "array" },
            "aggregation": { "type": "string" }
          }
        },
        "period_b": {
          "type": "object",
          "properties": {
            "label": { "type": "string" },
            "table": { "type": "string" },
            "column": { "type": "string" },
            "filters": { "type": "array" },
            "aggregation": { "type": "string" }
          }
        },
        "compare_type": {
          "type": "string",
          "enum": ["difference", "percentage_change", "ratio"]
        }
      }
    },
    "percentage": {
      "type": ["object", "null"],
      "description": "For percentage query type - calculate percentage contribution",
      "properties": {
        "numerator": {
          "type": "object",
          "properties": {
            "column": { "type": "string" },
            "filters": { "type": "array" },
            "aggregation": { "type": "string" }
          }
        },
        "denominator": {
          "type": "object",
          "properties": {
            "column": { "type": "string" },
            "filters": { "type": "array" },
            "aggregation": { "type": "string" }
          }
        }
      }
    },
    "trend": {
      "type": ["object", "null"],
      "description": "For trend query type - analyze patterns over time",
      "properties": {
        "date_column": { "type": "string" },
        "value_column": { "type": "string" },
        "aggregation": { "type": "string" },
        "period": {
          "type": "string",
          "enum": ["daily", "weekly", "monthly"]
        },
        "analysis_type": {
          "type": "string",
          "enum": ["direction", "pattern", "forecast"]
        }
      }
    },
    "projection": {
      "type": ["object", "null"],
      "description": "For projection query type - forecast future values based on historical data",
      "properties": {
        "base_value": { "type": "number", "description": "Current/base value to project from" },
        "base_label": { "type": "string", "description": "Label for the base value (e.g., category name)" },
        "projection_periods": { "type": "integer", "description": "Number of periods to forecast" },
        "growth_rate": { "type": "number", "description": "Estimated growth rate (0.0 = flat, 0.1 = 10% growth)" },
        "method": {
          "type": "string",
          "enum": ["linear", "average", "trend"],
          "description": "Projection method"
        }
      }
    }
  }
}
